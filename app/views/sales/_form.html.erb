<%= form_for(@sale) do |f| %>
  <% if @sale.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@sale.errors.count, "error") %> prohibited this sale from being saved:</h2>

      <ul>
      <% @sale.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>


  <div class="row">
    <div class="col-md-12">
      <table id="bought" class="table table-bordered">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Total</th>
            <th colspan="1"></th>
          </tr>
        </thead>
        <tbody id="body">
        </tbody>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12 text-center">
      <h1 id="total_sale"></h1>
    </div>
  </div>
  
  <% mayoreo = Store.find(current_user.store_id).wholesale %>

  <div class="field">
    <%= f.hidden_field :user_id, :value => current_user.id %>
  </div>
  <div class="field">
    <%= f.hidden_field :store_id, :value => current_user.store_id %>
  </div>

  <button class="btn btn-lg btn-primary">Terminar venta</button>

  <script>

  var ventas = []
  $( document ).ready(function() {
    /*
    // check checkbox for clicked row
    $('table').on('click', 'input[type=number]', function () {

        $(this).closest('tr').find('input[type=checkbox]').prop('checked', true);
    });
    */
    $(".add_product").on('click', function() {  
      var prd = $(this).closest('tr');
      if(prd.find('#quantity').val() == null || prd.find('#quantity').val() == ""){
        ventas.push({
        id: parseInt(prd.find('#number').attr('value')), 
        name: prd.find('#name').text(), 
        quantity: 1, 
        price: parseFloat(prd.find('#precio').attr('value'))});
      writeTable(ventas);
      writeTotal();
      }else{
        ventas.push({
        id: parseInt(prd.find('#number').attr('value')), 
        name: prd.find('#name').text(), 
        quantity: parseFloat(prd.find('#quantity').val()), 
        price: parseFloat(prd.find('#precio').attr('value'))});
      writeTable(ventas);
      writeTotal();
      }
      //alert(tr.find('#number').text());
    });
  });
/*
function writeTotal(array) {
  var total = 0;
  for(var i = 0; i < array.length; i++){
    total += array[i].price * array[i].quantity;
  };
  $('#total_sale').text('$ ' + total);
  
};*/



    // INICIO PRUEBA
    // FIN PRUEBA
    // remove check in inputs are empty for that row
    /*
    $('input[type=number]').blur(function () { 
        $('table tr').each(function () {
            var emptyRow = true;
            $(this).find("input[type=number]").each(function(){
                if($(this).val().length > 0) {
                   emptyRow = false;   
                }
            });        
            if (emptyRow) {
                $(this).find('input[type=checkbox]').prop('checked', false);
            }
        });
    }) */

function writeTotal() {
  var table = document.getElementById('bought'),
    cells = table.getElementsByClassName('totals');
  var total = 0;
  for(var i = 0, len = cells.length; i<len; i++){
    total += parseFloat($(cells[i]).attr('data-value'));
  };
  $('#total_sale').text('$ ' + total);
  
};
function deleteRow(btn) {
  var row = btn.parentNode.parentNode;
  row.parentNode.removeChild(row);
  writeTotal();
};


function writeTable(array) {
    // declare html variable (a string holder):
    var html = '';
    //for (var i = 0; i < array.length; i++) {
        // add opening <tr> tag to the string:
        html += '<tr>';
        
        html += '<td name="product_id[]" value=\'' + parseInt(array[array.length-1].id) + '\'>' + array[array.length-1].name + '</td>';
        if (array[array.length-1].quantity == NaN) {
        html += '<td name="quantity[]" value=\'1\'>1</td>';
        } else{
          html += '<td name="quantity[]" value=\'' + parseFloat(array[array.length-1].quantity) + '\'>' + parseFloat(array[array.length-1].quantity) + '</td>';
        };
        html += '<td class=\"totals\" data-value=\"' + array[array.length-1].quantity * array[array.length-1].price + '\"> $ ' + array[array.length-1].quantity * array[array.length-1].price + '</td>';
        html += '<td class="text-center"><button class="btn btn-danger" value="Delete" onclick="deleteRow(this)"><%= fa_icon "times" %></button></td>';
        // add closing </tr> tag to the string:
        html += '</tr>';
    //}
    //append created html to the table body:
    $('#body').append(html);

};

//$('.totals')function writeTotal
  </script>

  <table class="table table-bordered" id="sales">
    <thead>
      <tr>
        <th>ID</th>
        <th>Producto</th>
        <% if mayoreo %>
          <th>Mayoreo</th>
          <th>Menudeo</th>
        <% else %>
          <th>Precio</th>
        <% end %>
        <th>Disponible</th>
        <th width="10%">Cantidad</th>
        <th width="10%" colspan="1"></th>
      </tr>
    </thead>

    <tbody>
      <% @products.each do |product| %>
        <% case product.kind %>
        <% when 0 %>
        <tr style="background-color: white">
        <% when 1 %>
        <tr style="background-color: #22A7F0">
        <% when 2 %>
        <tr class="success">
        <% when 3 %>
        <tr style="background-color:#2ecc71">
        <% when 4 %>
        <tr style="background-color:#F7CA18">
        <% when 5 %>
        <tr class="warning">
        <% when 6 %>
        <tr style="background-color:#1BA39C">
        <% when 7 %>
        <tr class="success">
        <% when 8 %>
        <tr style="background-color:#9B59B6">
        <% when 9 %>
        <tr style="background-color:#D2527F">
        <% when 10 %>
        <tr style="background-color:#95A5A6">
        <% when 11 %>
        <tr style="background-color: #4183D7">
        <% else %>
        <tr style="background-color:#F7CA18">
        <% end %>
          <td id="number" value='<%= product.id %>'><%= product.product_number %></td>
          <td id="name"><%= product.sale_title %></td>
          <% if mayoreo %>
            <td id="precio_mayoreo" value="<%=product.wholesale_price %>"> $ <%=product.wholesale_price %></td>
            <td id="precio" value="<%=product.sale_price %>"> $ <%=product.sale_price %></td>
          <% else %>
            <td id="precio" value="<%=product.sale_price %>"> $ <%=product.sale_price %></td>
          <% end %>
          <td> <%= product.units.to_s + " " + product.measurement_unit %> </td>
          <td id="cantidad"> <%= number_field_tag  "quantity", nil , min: 0, max: product.units,class:'form-control', step: 'any' %> </td>
          <td class="text-center"><button onClick="return false;" class="add_product btn btn-success"><%= fa_icon "plus" %></button></td>
        </tr>
      <% end %>
    </tbody>
  </table>

      <!--
  <div class="field">
  <% total = 75 %>
    <h2>Total de venta:</h2>
    <%= f.text_field :total_price, :value => total %>
  </div>
  <div class="field">
    <%= f.label :items %><br>
    <%= f.number_field :items %>
  </div> -->
  <div class="row" id="terminar">
    <div class="col-md-6">
      <div class="field">
        <h2>Marcar Venta Pendiente: 
        <%= f.check_box :pending %>
        </h2>
      </div>
    </div>
    <% if mayoreo %>
      <div class="col-md-6">
        <div class="field">
          <h2>Marcar Venta de Mayoreo:
          <%= f.check_box :wholesale %>
          </h2>
        </div>
      </div>
    <% else %>
      <div class="field">
        <%= f.hidden_field :wholesale, :value => false %>
      </div>
    <% end %>
  </div>
  <div class="row">
    <div class="col-md-6">
      <br>
      <%= link_to 'Cancelar Venta', root_path, class:"btn btn-warning btn-lg btn-block field" %>
    </div>
    <div class="col-md-6">
      <div class="actions">
        <br>
        <%= f.submit "Terminar Venta", class:"btn btn-primary btn-lg btn-block field"%>
      </div>
    </div>
  </div>
<% end %>
